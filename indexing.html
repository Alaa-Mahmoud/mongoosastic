
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.2">
    
    
      
        <title>Indexing - Mongoosastic</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.816931ca.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?".":"."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#saving-a-document" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="Mongoosastic" class="md-header__button md-logo" aria-label="Mongoosastic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mongoosastic
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Indexing
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mongoosastic/mongoosastic/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    mongoosastic/mongoosastic
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="Mongoosastic" class="md-nav__button md-logo" aria-label="Mongoosastic" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Mongoosastic
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mongoosastic/mongoosastic/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    mongoosastic/mongoosastic
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="index.html" class="md-nav__link">
        Getting started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Indexing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="indexing.html" class="md-nav__link md-nav__link--active">
        Indexing
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#saving-a-document" class="md-nav__link">
    Saving a document
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removing-a-document" class="md-nav__link">
    Removing a document
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-nested-models" class="md-nav__link">
    Indexing Nested Models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elasticsearch-nested-datatype" class="md-nav__link">
    Elasticsearch Nested datatype
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-mongoose-references" class="md-nav__link">
    Indexing Mongoose References
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-an-existing-collection" class="md-nav__link">
    Indexing An Existing Collection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bulk-indexing" class="md-nav__link">
    Bulk Indexing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtered-indexing" class="md-nav__link">
    Filtered Indexing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-on-demand" class="md-nav__link">
    Indexing On Demand
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unindexing-on-demand" class="md-nav__link">
    Unindexing on demand
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#truncating-an-index" class="md-nav__link">
    Truncating an index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restrictions" class="md-nav__link">
    Restrictions
  </a>
  
    <nav class="md-nav" aria-label="Restrictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-indexing" class="md-nav__link">
    Auto indexing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-immediately-after-es-indexed-event" class="md-nav__link">
    Search immediately after es-indexed event
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="mapping.html" class="md-nav__link">
        Mapping
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="queries.html" class="md-nav__link">
        Queries
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#saving-a-document" class="md-nav__link">
    Saving a document
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#removing-a-document" class="md-nav__link">
    Removing a document
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-nested-models" class="md-nav__link">
    Indexing Nested Models
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elasticsearch-nested-datatype" class="md-nav__link">
    Elasticsearch Nested datatype
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-mongoose-references" class="md-nav__link">
    Indexing Mongoose References
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-an-existing-collection" class="md-nav__link">
    Indexing An Existing Collection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bulk-indexing" class="md-nav__link">
    Bulk Indexing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#filtered-indexing" class="md-nav__link">
    Filtered Indexing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#indexing-on-demand" class="md-nav__link">
    Indexing On Demand
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unindexing-on-demand" class="md-nav__link">
    Unindexing on demand
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#truncating-an-index" class="md-nav__link">
    Truncating an index
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#restrictions" class="md-nav__link">
    Restrictions
  </a>
  
    <nav class="md-nav" aria-label="Restrictions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-indexing" class="md-nav__link">
    Auto indexing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#search-immediately-after-es-indexed-event" class="md-nav__link">
    Search immediately after es-indexed event
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/mongoosastic/mongoosastic/edit/master/docs/indexing.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


  <h1>Indexing</h1>

<h2 id="saving-a-document">Saving a document</h2>
<p>The indexing takes place after saving in mongodb and is a deferred process.
One can check the end of the indexation by catching the es-indexed event.</p>
<div class="highlight"><pre><span></span><code><span class="nx">doc</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="cm">/* Document indexation on going */</span>
  <span class="nx">doc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;es-indexed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="cm">/* Document is indexed */</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="removing-a-document">Removing a document</h2>
<p>Removing a document, or unindexing, takes place when a document is removed by calling <code>.remove()</code> on a mongoose Document instance.
One can check the end of the unindexing by catching the es-removed event.</p>
<div class="highlight"><pre><span></span><code><span class="nx">doc</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
  <span class="cm">/* Document unindexing in the background */</span>
  <span class="nx">doc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;es-removed&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="cm">/* Docuemnt is unindexed */</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>Note that use of <code>Model.remove</code> does not involve mongoose documents as outlined in the <a href="http://mongoosejs.com/docs/api.html#model_Model.remove">documentation</a>. Therefore, the following will not unindex the document.</p>
<div class="highlight"><pre><span></span><code><span class="nx">MyModel</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">id</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* doc remains in Elasticsearch cluster */</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="indexing-nested-models">Indexing Nested Models</h2>
<p>In order to index nested models you can refer following example.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">Comment</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">author</span><span class="o">:</span> <span class="nb">String</span>
<span class="p">})</span>


<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">es_indexed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">city</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="p">[</span><span class="nx">Comment</span><span class="p">],</span> <span class="nx">es_indexed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">})</span>

<span class="nx">User</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">mongoosastic</span><span class="p">)</span>
</code></pre></div>
<h2 id="elasticsearch-nested-datatype">Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html">Nested datatype</a></h2>
<p>Since the default in Elasticsearch is to take arrays and flatten them into objects,
it can make it hard to write queries where you need to maintain the relationships
between objects in the array.
The way to change this behavior is by changing the Elasticsearch type from <code>object</code>
(the mongoosastic default) to <code>nested</code></p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">Comment</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">author</span><span class="o">:</span> <span class="nb">String</span>
<span class="p">})</span>


<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">es_indexed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">city</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span><span class="p">[</span><span class="nx">Comment</span><span class="p">],</span>
      <span class="nx">es_indexed</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">es_type</span><span class="o">:</span> <span class="s1">&#39;nested&#39;</span><span class="p">,</span>
      <span class="nx">es_include_in_parent</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">User</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">mongoosastic</span><span class="p">)</span>
</code></pre></div>
<h2 id="indexing-mongoose-references">Indexing Mongoose References</h2>
<p>In order to index mongoose references you can refer following example.</p>
<p><div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">Comment</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">body</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">author</span><span class="o">:</span> <span class="nb">String</span>
<span class="p">});</span>


<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">es_indexed</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">city</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="nx">comments</span><span class="o">:</span> <span class="p">{</span> 
      <span class="nx">type</span><span class="o">:</span> <span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
      <span class="nx">ref</span><span class="o">:</span> <span class="s1">&#39;Comment&#39;</span><span class="p">,</span>
      <span class="nx">es_schema</span><span class="o">:</span> <span class="nx">Comment</span><span class="p">,</span>
      <span class="nx">es_indexed</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span>
      <span class="nx">es_select</span><span class="o">:</span> <span class="s1">&#39;title body&#39;</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">User</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">mongoosastic</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">populate</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="nx">select</span><span class="o">:</span> <span class="s1">&#39;title body&#39;</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">})</span>
</code></pre></div>
In the schema you'll need to provide <code>es_schema</code> field - the referenced schema.
By default every field of the referenced schema will be mapped. Use <code>es_select</code> field to pick just specific fields.</p>
<p><code>populate</code> is an array of options objects you normally pass to
<a href="http://mongoosejs.com/docs/api.html#model_Model.populate">Model.populate</a>.</p>
<h2 id="indexing-an-existing-collection">Indexing An Existing Collection</h2>
<p>Already have a mongodb collection that you'd like to index using this
plugin? No problem! Simply call the synchronize method on your model to
open a mongoose stream and start indexing documents individually.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">BookSchema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nb">String</span>
<span class="p">});</span>
<span class="nx">BookSchema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">mongoosastic</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">Book</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span> <span class="nx">BookSchema</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">synchronize</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span>

<span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;indexed &#39;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s1">&#39; documents!&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>You can also synchronize a subset of documents based on a query!</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">synchronize</span><span class="p">({</span> <span class="nx">author</span><span class="o">:</span> <span class="s1">&#39;Arthur C. Clarke&#39;</span> <span class="p">})</span>
</code></pre></div>
<p>As well as specifying synchronization options</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">stream</span> <span class="o">=</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">synchronize</span><span class="p">({},</span> <span class="p">{</span> <span class="nx">saveOnSynchronize</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</code></pre></div>
<p>Options are:</p>
<ul>
<li><code>saveOnSynchronize</code> - triggers Mongoose save (and pre-save) method when synchronizing a collection/index. Defaults to global <code>saveOnSynchronize</code> option.</li>
</ul>
<h2 id="bulk-indexing">Bulk Indexing</h2>
<p>You can also specify <code>bulk</code> options with mongoose which will utilize Elasticsearch's bulk indexing api. This will cause the <code>synchronize</code> function to use bulk indexing as well.</p>
<p>Mongoosastic will wait 1 second (or specified delay) until it has 1000 docs (or specified size) and then perform bulk indexing.</p>
<div class="highlight"><pre><span></span><code><span class="nx">BookSchema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">mongoosastic</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">bulk</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">size</span><span class="o">:</span> <span class="mf">10</span><span class="p">,</span> <span class="c1">// preferred number of docs to bulk index</span>
    <span class="nx">delay</span><span class="o">:</span> <span class="mf">100</span> <span class="c1">//milliseconds to wait for enough docs to meet size constraint</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<h2 id="filtered-indexing">Filtered Indexing</h2>
<p>You can specify a filter function to index a model to Elasticsearch based on some specific conditions.</p>
<p>Filtering function must return True for conditions that will ignore indexing to Elasticsearch.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nx">MovieSchema</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">Schema</span><span class="p">({</span>
  <span class="nx">title</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span> <span class="p">},</span>
  <span class="nx">genre</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span> <span class="kr">enum</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;horror&#39;</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;adventure&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">MovieSchema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">mongoosastic</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">filter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">genre</span> <span class="o">===</span> <span class="s1">&#39;action&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>Instances of Movie model having 'action' as their genre will not be indexed to Elasticsearch.</p>
<h2 id="indexing-on-demand">Indexing On Demand</h2>
<p>You can do on-demand indexes using the <code>index</code> function</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span> <span class="nx">dude</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Dude</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span><span class="s1">&#39;Jeffrey Lebowski&#39;</span> <span class="p">});</span>

<span class="nx">dude</span><span class="p">.</span><span class="nx">awesome</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="k">await</span> <span class="nx">dude</span><span class="p">.</span><span class="nx">index</span><span class="p">();</span>
</code></pre></div>
<p>The index method takes as arguments:</p>
<ul>
<li><code>options</code> (optional) - { index: string } - the index to publish to. Defaults to the standard index that
  the model was setup with.</li>
</ul>
<p>Note that indexing a model does not mean it will be persisted to
mongodb. Use <code>save()</code> for that.</p>
<h2 id="unindexing-on-demand">Unindexing on demand</h2>
<p>You can remove a document from the Elasticsearch cluster by using the <code>unIndex</code> function.</p>
<div class="highlight"><pre><span></span><code><span class="k">await</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">unIndex</span><span class="p">();</span>
</code></pre></div>
<h2 id="truncating-an-index">Truncating an index</h2>
<p>The static method <code>esTruncate</code> will delete all documents from the associated index. This method combined with <code>synchronize()</code> can be useful in case of integration tests for example when each test case needs a cleaned up index in Elasticsearch.</p>
<div class="highlight"><pre><span></span><code><span class="k">await</span> <span class="nx">GarbageModel</span><span class="p">.</span><span class="nx">esTruncate</span><span class="p">();</span>
</code></pre></div>
<h2 id="restrictions">Restrictions</h2>
<h3 id="auto-indexing">Auto indexing</h3>
<p>Mongoosastic try to auto index documents in favor of mongoose's <a href="http://mongoosejs.com/docs/middleware.html">middleware</a> feature.</p>
<p>Mongoosastic will auto index when:</p>
<ul>
<li><code>document.save</code></li>
<li><code>Model.findOneAndUpdate</code></li>
<li><code>Model.insertMany</code></li>
<li><code>document.remove</code></li>
<li><code>Model.findOneAndRemove</code> </li>
</ul>
<p>but not include <code>Model.remove</code> &amp; <code>Model.update</code>.</p>
<p>And you should have <code>new: true</code> options when <code>findOneAndUpdate</code> so that mongoosastic can get new values in post hook.</p>
<h3 id="search-immediately-after-es-indexed-event">Search immediately after es-indexed event</h3>
<blockquote>
<p>Elasticsearch by default refreshes each shard every 1s, so the document will be available to search 1s after indexing it.</p>
</blockquote>
<p>The event <code>es-indexed</code> means that elasticsearch received the index request, and if you want to search the document, please try after 1s. See <a href="https://github.com/elastic/elasticsearch-js/issues/231">Document not found immediately after it is saved</a>.</p>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="index.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Getting started" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Getting started
            </div>
          </div>
        </a>
      
      
        
        <a href="mapping.html" class="md-footer__link md-footer__link--next" aria-label="Next: Mapping" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Mapping
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.top", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "assets/javascripts/workers/search.01824240.min.js"}</script>
    
    
      <script src="assets/javascripts/bundle.ff0eccb3.min.js"></script>
      
    
  </body>
</html>